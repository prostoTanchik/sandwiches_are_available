{% extends "base.html" %}
{% block content %}

<h1>üö® –í–ê–®–ê –ö–û–†–ó–ò–ù–ê (–¶–ï–ù–´ –†–ê–°–¢–£–¢!) üö®</h1>

<div class="cart-container">
    <!-- COUNTDOWN TIMER (PRICES GO UP!) -->
    <div class="countdown-timer" id="countdown">
        ‚è≥ –¶–µ–Ω—ã –≤—ã—Ä–∞—Å—Ç—É—Ç —á–µ—Ä–µ–∑: <span id="timer">30</span> —Å–µ–∫
    </div>

    <!-- FORCED SOCIAL LOGIN -->
    <div id="socialLogin" class="social-login">
        üîí –í–û–ô–¢–ò –ß–ï–†–ï–ó –ì–û–°–£–°–õ–£–ì–ò (–ò–õ–ò –£–ô–¢–ò –ì–û–õ–û–î–ù–´–ú)
    </div>

    <!-- CAPTCHA BEFORE ANY ACTION -->
    <div id="captchaBox" class="captcha-box" style="display: none;">
        <p>–î–æ–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤—ã –Ω–µ —Ä–æ–±–æ—Ç:</p>
        <p>–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2 + 2 –≤ –¥–≤–æ–∏—á–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ?</p>
        <input type="text" id="captchaInput">
        <button onclick="validateCaptcha()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>

    <!-- CART ITEMS -->
    {% if cart %}
        {% for item in cart %}
        <div class="cart-item">
            <span class="item-name">{{ item.description }}</span>
            <span class="item-price">{{ "%.2f"|format(item.price) }} ‚ÇΩ</span>
            <button class="remove-btn" onclick="startRemoveItem({{ loop.index0 }})">‚úï</button>
        </div>
        {% endfor %}
        
        <div class="total">
            –ò–¢–û–ì–û: <span id="dynamicTotal">{{ "%.2f"|format(total) }}</span> ‚ÇΩ <br>
            <small>(+ —á–∞–µ–≤—ã–µ {{ "%.2f"|format(total * 0.5) }} ‚ÇΩ)</small>
        </div>
        
        <button class="checkout-btn" onclick="startCheckout()">–û–ü–õ–ê–¢–ò–¢–¨ (–ù–ï –ù–ê–ñ–ò–ú–ê–¢–¨)</button>
        
        <div class="secret-note">
            –ü–°–°–¢... –•–û–¢–ò–¢–ï –°–ö–ò–î–ö–£ 90%? –í–í–ï–î–ò–¢–ï –ö–û–î "BREADGOD" –ù–ê –°–õ–ï–î–£–Æ–©–ï–ú –≠–ö–†–ê–ù–ï
            (–≠–¢–û –ù–ï –õ–û–í–£–®–ö–ê)
        </div>
    {% else %}
        <div class="empty-cart">
            üö´ –í–ê–®–ê –ö–û–†–ó–ò–ù–ê –ü–£–°–¢–ê üö´<br>
            <small>–ö–∞–∫ –∏ –≤–∞—à–∞ –¥—É—à–∞</small>
        </div>
    {% endif %}
</div>

<!-- MYSTERY ITEM NOTIFICATION -->
<div id="mysteryNotification" class="notification" style="display: none;">
    üéâ –í–ê–ú –î–û–ë–ê–í–õ–ï–ù –¢–ê–ò–ù–°–¢–í–ï–ù–ù–´–ô –ë–£–¢–ï–†–ë–†–û–î!üéâ
    —É–¥–∞–ª–∏—Ç—å –µ–≥–æ —É–∂–µ –Ω–µ–ª—å–∑—è, –Ω–µ –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç–µ!
</div>

<script>
    // ==== COUNTDOWN TIMER (PRICES INCREASE!) ====
    let timeLeft = 30;
    const countdown = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").textContent = timeLeft;
        
        if (timeLeft <= 0) {
            // Increase all prices by 10%
            document.querySelectorAll(".item-price").forEach(priceEl => {
                const currentPrice = parseFloat(priceEl.textContent);
                const newPrice = currentPrice * 1.10;
                priceEl.textContent = newPrice.toFixed(2);
            });
            timeLeft = 30;
        }
    }, 1000);

    // ==== AUTO-ADD MYSTERY ITEM (EVERY 30 SEC) ====
    setInterval(() => {
        fetch('/add_mystery_item', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ surprise: true })
        }).then(() => {
            const notif = document.getElementById("mysteryNotification");
            notif.style.display = "block";
            setTimeout(() => { notif.style.display = "none"; }, 3000);
            location.reload();
        });
    }, 30000);

    // ==== FORCE SOCIAL LOGIN ====
    document.getElementById("socialLogin").addEventListener("click", () => {
        alert("–ü–û–ö–ê –í –†–ê–ó–†–ê–ë–û–¢–ö–ï, –ù–û –°–ö–û–†–û –¢–£–¢ –í–°–Å –ë–£–î–ï–¢ –†–ê–ë–û–¢–ê–¢–¨ –ù–ê–í–ï–†–ù–û–ï");
    });

    // ==== CAPTCHA FOR EVERY ACTION ====
    function startRemoveItem(index) {
        showCaptcha(() => removeItem(index));
    }

    function startCheckout() {
        showCaptcha(() => checkout());
    }

    function showCaptcha(callback) {
        document.getElementById("captchaBox").style.display = "block";
        window.captchaCallback = callback;
    }

    function validateCaptcha() {
        const answer = document.getElementById("captchaInput").value;
        if (answer === "100") {
            document.getElementById("captchaBox").style.display = "none";
            window.captchaCallback();
        } else {
            alert("–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û! –ü–û–ü–†–û–ë–£–ô–¢–ï –ï–©–ï –†–ê–ó.");
        }
    }

    // ==== REMOVE ITEM (50% CHANCE TO FAIL) ====
    function removeItem(index) {
        if (Math.random() > 0.5) {
            alert("–û–®–ò–ë–ö–ê: –í–´ –ù–ï –ú–û–ñ–ï–¢–ï –£–î–ê–õ–ò–¢–¨ –≠–¢–û–¢ –ü–†–ï–î–ú–ï–¢.");
            return;
        }
        fetch('/remove_from_cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ index: index })
        }).then(() => location.reload());
    }

    // ==== CHECKOUT (MULTIPLE CONFIRMATIONS) ====
    function checkout() {
        if (confirm("–í–´ –£–í–ï–†–ï–ù–´?")) {
            if (confirm("–°–ï–†–¨–ï–ó–ù–û?")) {
                if (confirm("–ü–û–°–õ–ï–î–ù–ò–ô –®–ê–ù–°!")) {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    fetch('/create_order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cart: {{ cart|tojson }} })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –∑–∞–∫–∞–∑—ã
                            fetch('/clear_cart', { method: 'POST' })
                                .then(() => window.location.href = '/orders');
                        } else {
                            alert("–û–®–ò–ë–ö–ê: " + data.message);
                        }
                    })
                    .catch(error => {
                        alert("–û–®–ò–ë–ö–ê –ü–õ–ê–¢–ï–ñ–ê: " + error.message);
                    });
                }
            }
        }
    }
</script>

{% endblock %}